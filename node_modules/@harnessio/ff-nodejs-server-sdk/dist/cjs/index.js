var Pr=Object.create;var ve=Object.defineProperty,Sr=Object.defineProperties,_r=Object.getOwnPropertyDescriptor,Cr=Object.getOwnPropertyDescriptors,Or=Object.getOwnPropertyNames,ut=Object.getOwnPropertySymbols,Ir=Object.getPrototypeOf,lt=Object.prototype.hasOwnProperty,wr=Object.prototype.propertyIsEnumerable;var ct=(r,e,t)=>e in r?ve(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,f=(r,e)=>{for(var t in e||(e={}))lt.call(e,t)&&ct(r,t,e[t]);if(ut)for(var t of ut(e))wr.call(e,t)&&ct(r,t,e[t]);return r},Oe=(r,e)=>Sr(r,Cr(e)),ft=r=>ve(r,"__esModule",{value:!0});var N=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),Nr=(r,e)=>{ft(r);for(var t in e)ve(r,t,{get:e[t],enumerable:!0})},Dr=(r,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Or(e))!lt.call(r,i)&&i!=="default"&&ve(r,i,{get:()=>e[i],enumerable:!(t=_r(e,i))||t.enumerable});return r},D=r=>Dr(ft(ve(r!=null?Pr(Ir(r)):{},"default",r&&r.__esModule&&"default"in r?{get:()=>r.default,enumerable:!0}:{value:r,enumerable:!0})),r);var pt=N((Ei,mt)=>{"use strict";function Ge(r){this.message=r}Ge.prototype=new Error,Ge.prototype.name="InvalidCharacterError";var ht=typeof window!="undefined"&&window.atob&&window.atob.bind(window)||function(r){var e=String(r).replace(/=+$/,"");if(e.length%4==1)throw new Ge("'atob' failed: The string to be decoded is not correctly encoded.");for(var t,i,n=0,s=0,a="";i=e.charAt(s++);~i&&(t=n%4?64*t+i:i,n++%4)?a+=String.fromCharCode(255&t>>(-2*n&6)):0)i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(i);return a};function Fr(r){var e=r.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw"Illegal base64url string!"}try{return function(t){return decodeURIComponent(ht(t).replace(/(.)/g,function(i,n){var s=n.charCodeAt(0).toString(16).toUpperCase();return s.length<2&&(s="0"+s),"%"+s}))}(e)}catch(t){return ht(e)}}function ye(r){this.message=r}function gt(r,e){if(typeof r!="string")throw new ye("Invalid token specified");var t=(e=e||{}).header===!0?0:1;try{return JSON.parse(Fr(r.split(".")[t]))}catch(i){throw new ye("Invalid token specified: "+i.message)}}ye.prototype=new Error,ye.prototype.name="InvalidTokenError";var Ke=gt;Ke.default=gt,Ke.InvalidTokenError=ye,mt.exports=Ke});var vt=N((Ti,dt)=>{"use strict";var Vr=["ETIMEDOUT","ECONNRESET","EADDRINUSE","ESOCKETTIMEDOUT","ECONNREFUSED","EPIPE","EHOSTUNREACH","EAI_AGAIN"],Ur=["ENOTFOUND","ENETUNREACH","UNABLE_TO_GET_ISSUER_CERT","UNABLE_TO_GET_CRL","UNABLE_TO_DECRYPT_CERT_SIGNATURE","UNABLE_TO_DECRYPT_CRL_SIGNATURE","UNABLE_TO_DECODE_ISSUER_PUBLIC_KEY","CERT_SIGNATURE_FAILURE","CRL_SIGNATURE_FAILURE","CERT_NOT_YET_VALID","CERT_HAS_EXPIRED","CRL_NOT_YET_VALID","CRL_HAS_EXPIRED","ERROR_IN_CERT_NOT_BEFORE_FIELD","ERROR_IN_CERT_NOT_AFTER_FIELD","ERROR_IN_CRL_LAST_UPDATE_FIELD","ERROR_IN_CRL_NEXT_UPDATE_FIELD","OUT_OF_MEM","DEPTH_ZERO_SELF_SIGNED_CERT","SELF_SIGNED_CERT_IN_CHAIN","UNABLE_TO_GET_ISSUER_CERT_LOCALLY","UNABLE_TO_VERIFY_LEAF_SIGNATURE","CERT_CHAIN_TOO_LONG","CERT_REVOKED","INVALID_CA","PATH_LENGTH_EXCEEDED","INVALID_PURPOSE","CERT_UNTRUSTED","CERT_REJECTED"];dt.exports=function(r){return!r||!r.code||Vr.indexOf(r.code)!==-1?!0:Ur.indexOf(r.code)===-1}});var Rt=N(Y=>{"use strict";Object.defineProperty(Y,"__esModule",{value:!0});var Lr=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r};Y.isNetworkError=je;Y.isRetryableError=Ie;Y.isSafeRequestError=Et;Y.isIdempotentRequestError=ze;Y.isNetworkOrIdempotentRequestError=He;Y.exponentialDelay=Tt;Y.default=ie;var Br=vt(),qr=Mr(Br);function Mr(r){return r&&r.__esModule?r:{default:r}}var ke="axios-retry";function je(r){return!r.response&&Boolean(r.code)&&r.code!=="ECONNABORTED"&&(0,qr.default)(r)}var yt=["get","head","options"],Gr=yt.concat(["put","delete"]);function Ie(r){return r.code!=="ECONNABORTED"&&(!r.response||r.response.status>=500&&r.response.status<=599)}function Et(r){return r.config?Ie(r)&&yt.indexOf(r.config.method)!==-1:!1}function ze(r){return r.config?Ie(r)&&Gr.indexOf(r.config.method)!==-1:!1}function He(r){return je(r)||ze(r)}function Kr(){return 0}function Tt(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,e=Math.pow(2,r)*100,t=e*.2*Math.random();return e+t}function At(r){var e=r[ke]||{};return e.retryCount=e.retryCount||0,r[ke]=e,e}function kr(r,e){return Object.assign({},e,r[ke])}function jr(r,e){r.defaults.agent===e.agent&&delete e.agent,r.defaults.httpAgent===e.httpAgent&&delete e.httpAgent,r.defaults.httpsAgent===e.httpsAgent&&delete e.httpsAgent}async function zr(r,e,t,i){var n=t.retryCount<r&&e(i);if((typeof n=="undefined"?"undefined":Lr(n))==="object")try{return await n,!0}catch(s){return!1}return n}function ie(r,e){r.interceptors.request.use(function(t){var i=At(t);return i.lastRequestTime=Date.now(),t}),r.interceptors.response.use(null,async function(t){var i=t.config;if(!i)return Promise.reject(t);var n=kr(i,e),s=n.retries,a=s===void 0?3:s,u=n.retryCondition,c=u===void 0?He:u,o=n.retryDelay,l=o===void 0?Kr:o,m=n.shouldResetTimeout,A=m===void 0?!1:m,C=At(i);if(await zr(a,c,C,t)){C.retryCount+=1;var P=l(C.retryCount,t);if(jr(r,i),!A&&i.timeout&&C.lastRequestTime){var W=Date.now()-C.lastRequestTime;i.timeout=Math.max(i.timeout-W-P,1)}return i.transformRequest=[function(h){return h}],new Promise(function(h){return setTimeout(function(){return h(r(i))},P)})}return Promise.reject(t)})}ie.isNetworkError=je;ie.isSafeRequestError=Et;ie.isIdempotentRequestError=ze;ie.isNetworkOrIdempotentRequestError=He;ie.exponentialDelay=Tt;ie.isRetryableError=Ie});var xt=N((Ri,bt)=>{bt.exports=Rt().default});var _t=N((Yi,St)=>{function F(r,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}St.exports=F;F.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};F.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};F.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var e=new Date().getTime();if(r&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var i=this;return this._timer=setTimeout(function(){i._attempts++,i._operationTimeoutCb&&(i._timeout=setTimeout(function(){i._operationTimeoutCb(i._attempts)},i._operationTimeout),i._options.unref&&i._timeout.unref()),i._fn(i._attempts)},t),this._options.unref&&this._timer.unref(),!0};F.prototype.attempt=function(r,e){this._fn=r,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};F.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)};F.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)};F.prototype.start=F.prototype.try;F.prototype.errors=function(){return this._errors};F.prototype.attempts=function(){return this._attempts};F.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},e=null,t=0,i=0;i<this._errors.length;i++){var n=this._errors[i],s=n.message,a=(r[s]||0)+1;r[s]=a,a>=t&&(e=n,t=a)}return e}});var Ct=N(ae=>{var Qr=_t();ae.operation=function(r){var e=ae.timeouts(r);return new Qr(e,{forever:r&&(r.forever||r.retries===1/0),unref:r&&r.unref,maxRetryTime:r&&r.maxRetryTime})};ae.timeouts=function(r){if(r instanceof Array)return[].concat(r);var e={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var t in r)e[t]=r[t];if(e.minTimeout>e.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],n=0;n<e.retries;n++)i.push(this.createTimeout(n,e));return r&&r.forever&&!i.length&&i.push(this.createTimeout(n,e)),i.sort(function(s,a){return s-a}),i};ae.createTimeout=function(r,e){var t=e.randomize?Math.random()+1:1,i=Math.round(t*Math.max(e.minTimeout,1)*Math.pow(e.factor,r));return i=Math.min(i,e.maxTimeout),i};ae.wrap=function(r,e,t){if(e instanceof Array&&(t=e,e=null),!t){t=[];for(var i in r)typeof r[i]=="function"&&t.push(i)}for(var n=0;n<t.length;n++){var s=t[n],a=r[s];r[s]=function(c){var o=ae.operation(e),l=Array.prototype.slice.call(arguments,1),m=l.pop();l.push(function(A){o.retry(A)||(A&&(arguments[0]=o.mainError()),m.apply(this,arguments))}),o.attempt(function(){c.apply(r,l)})}.bind(r,a),r[s].options=e}}});var It=N((Qi,Ot)=>{Ot.exports=Ct()});var Lt=N((Ji,Ut)=>{var wt=require("url").parse,Jr=require("events"),Wr=require("https"),Xr=require("http"),Zr=require("util"),Nt=It(),ei=["pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","secureProtocol","servername","checkServerIdentity"],Dt=[239,187,191],ti=58,ri=32,Ft=10,ii=13,Vt=1024*256,ni=/^(cookie|authorization)$/i;function si(r){return Dt.every(function(e,t){return r[t]===e})}function d(r,e){var t=d.CONNECTING,i=e&&e.headers,n=!1;Object.defineProperty(this,"readyState",{get:function(){return t}}),Object.defineProperty(this,"url",{get:function(){return r}});var s=this;s.reconnectInterval=1e3;function a(){P&&(r=P,P=null,n=!1);var g=Nt.operation({retries:15,factor:2,minTimeout:1e3,maxTimeout:3e3,randomize:!0}),v=Nt.operation({forever:!0,factor:3,minTimeout:3e5,maxTimeout:3e5,randomize:!0});function b(){t!==d.CLOSED&&y()}function y(){g.attempt(function(B){h("retrying",new ee("retrying",{shortTermRetryAttempt:B})),t===d.RETRYING&&(W(),!g.retry(t===d.RETRYING)&&t===d.RETRYING&&z())})}function z(){v.attempt(function(B){t===d.RETRYING&&(h("retrying",new ee("retrying",{longTermRetryAttempt:B})),W(),v.retry(t===d.RETRYING))})}b()}function u(g){if(g&&g.status){var v=g.status;return v===500||v===502||v===503||v===504}return!0}function c(g){if(t!==d.CLOSED){var v=new ee("error",{error:g});if(h("retrying",new ee("retrying",{error:g})),u(g)){if(t===d.RETRYING)return;t=d.RETRYING,a(g)}else t=d.CLOSED,h("error",v),h("closed",new ee("closed"))}}var o,l="";i&&i["Last-Event-ID"]&&(l=i["Last-Event-ID"],delete i["Last-Event-ID"]);var m=!1,A="",C="",P=null;function W(){var g=wt(r),v=g.protocol==="https:";if(g.headers={"Cache-Control":"no-cache",Accept:"text/event-stream"},l&&(g.headers["Last-Event-ID"]=l),i){var b=n?oi(i):i;for(var y in b){var z=b[y];z&&(g.headers[y]=z)}}g.rejectUnauthorized=!(e&&!e.rejectUnauthorized),e&&e.createConnection!==void 0&&(g.createConnection=e.createConnection);var B=e&&e.proxy;if(B){var O=wt(e.proxy);v=O.protocol==="https:",g.protocol=v?"https:":"http:",g.path=r,g.headers.Host=g.host,g.hostname=O.hostname,g.host=O.host,g.port=O.port}if(e&&e.https){for(var q in e.https)if(ei.indexOf(q)!==-1){var ce=e.https[q];ce!==void 0&&(g[q]=ce)}}e&&e.withCredentials!==void 0&&(g.withCredentials=e.withCredentials),o=(v?Wr:Xr).request(g,function(E){if(E.statusCode>=400&&E.statusCode<=599){c({status:E.statusCode,message:E.statusMessage});return}if(E.statusCode===301||E.statusCode===302||E.statusCode===307){var Le=E.headers.location;if(!Le){c({status:E.statusCode,message:E.statusMessage});return}var br=new URL(r).origin,xr=new URL(Le).origin;n=br!==xr,E.statusCode===307&&(P=r),r=Le,process.nextTick(W);return}if(E.statusCode>=400&&E.statusCode<=599)return h("error",new ee("error",{status:E.statusCode,message:E.statusMessage})),s.close();t=d.OPEN,E.on("close",function(){E.removeAllListeners("close"),E.removeAllListeners("end"),c({message:"server closed the connection"})}),E.on("end",function(){E.removeAllListeners("close"),E.removeAllListeners("end"),c({message:"server ended the connection"})}),h("open",new ee("open"));var R,Be,qe=0,Me=-1,Pe=0,H=0;E.on("data",function(fe){R?(fe.length>R.length-H&&(Pe=R.length*2+fe.length,Pe>Vt&&(Pe=R.length+fe.length+Vt),Be=Buffer.alloc(Pe),R.copy(Be,0,0,H),R=Be),fe.copy(R,H),H+=fe.length):(R=fe,si(R)&&(R=R.slice(Dt.length)),H=R.length);for(var w=0,Se=H;w<Se;){m&&(R[w]===Ft&&++w,m=!1);for(var he=-1,_e=Me,Ce,ge=qe;he<0&&ge<Se;++ge)Ce=R[ge],Ce===ti?_e<0&&(_e=ge-w):Ce===ii?(m=!0,he=ge-w):Ce===Ft&&(he=ge-w);if(he<0){qe=Se-w,Me=_e;break}else qe=0,Me=-1;T(R,w,_e,he),w+=he+1}w===Se?(R=void 0,H=0):w>0&&(R=R.slice(w,H),H=R.length)})}),o.on("error",function(E){c(E.message)});var X=3e4;o.setTimeout(X),o.on("timeout",function(){c({message:`Read timeout, received no data in ${X}ms, assuming connection is dead`})}),o.setNoDelay&&o.setNoDelay(!0),o.end()}W();function h(){s.listeners(arguments[0]).length>0&&s.emit.apply(s,arguments)}this._close=function(){t!==d.CLOSED&&(t=d.CLOSED,o.abort&&o.abort(),o.xhr&&o.xhr.abort&&o.xhr.abort(),h("closed",new ee("closed")))};function T(g,v,b,y){if(y===0){if(A.length>0){var z=C||"message";h(z,new ai(z,{data:A.slice(0,-1),lastEventId:l,origin:new URL(r).origin})),A=""}C=void 0}else if(b>0){var B=b<0,O=0,q=g.slice(v,v+(B?y:b)).toString();B?O=y:g[v+b+1]!==ri?O=b+1:O=b+2,v+=O;var ce=y-O,X=g.slice(v,v+ce).toString();q==="data"?A+=X+`
`:q==="event"?C=X:q==="id"&&(l=X)}}}Ut.exports=d;Zr.inherits(d,Jr.EventEmitter);d.prototype.constructor=d;["open","error","retrying","closed","message"].forEach(function(r){Object.defineProperty(d.prototype,"on"+r,{get:function(){var t=this.listeners(r)[0];return t?t._listener?t._listener:t:void 0},set:function(t){this.removeAllListeners(r),this.addEventListener(r,t)}})});Object.defineProperty(d,"CONNECTING",{enumerable:!0,value:0});Object.defineProperty(d,"OPEN",{enumerable:!0,value:1});Object.defineProperty(d,"CLOSED",{enumerable:!0,value:2});Object.defineProperty(d,"RETRYING",{enumerable:!0,value:3});d.prototype.CONNECTING=0;d.prototype.OPEN=1;d.prototype.CLOSED=2;d.prototype.RETRYING=3;d.prototype.close=function(){this._close()};d.prototype.addEventListener=function(e,t){typeof t=="function"&&(t._listener=t,this.on(e,t))};d.prototype.dispatchEvent=function(e){if(!e.type)throw new Error("UNSPECIFIED_EVENT_TYPE_ERR");this.emit(e.type,e)};d.prototype.removeEventListener=function(e,t){typeof t=="function"&&(t._listener=void 0,this.removeListener(e,t))};function ee(r,e){if(Object.defineProperty(this,"type",{writable:!1,value:r,enumerable:!0}),e)for(var t in e)e.hasOwnProperty(t)&&Object.defineProperty(this,t,{writable:!1,value:e[t],enumerable:!0})}function ai(r,e){Object.defineProperty(this,"type",{writable:!1,value:r,enumerable:!0});for(var t in e)e.hasOwnProperty(t)&&Object.defineProperty(this,t,{writable:!1,value:e[t],enumerable:!0})}function oi(r){var e={};for(var t in r)ni.test(t)||(e[t]=r[t]);return e}});var Mt=N((tn,qt)=>{"use strict";qt.exports=function(r){r.prototype[Symbol.iterator]=function*(){for(let e=this.head;e;e=e.next)yield e.value}}});var Kt=N((rn,Gt)=>{"use strict";Gt.exports=p;p.Node=oe;p.create=p;function p(r){var e=this;if(e instanceof p||(e=new p),e.tail=null,e.head=null,e.length=0,r&&typeof r.forEach=="function")r.forEach(function(n){e.push(n)});else if(arguments.length>0)for(var t=0,i=arguments.length;t<i;t++)e.push(arguments[t]);return e}p.prototype.removeNode=function(r){if(r.list!==this)throw new Error("removing node which does not belong to this list");var e=r.next,t=r.prev;return e&&(e.prev=t),t&&(t.next=e),r===this.head&&(this.head=e),r===this.tail&&(this.tail=t),r.list.length--,r.next=null,r.prev=null,r.list=null,e};p.prototype.unshiftNode=function(r){if(r!==this.head){r.list&&r.list.removeNode(r);var e=this.head;r.list=this,r.next=e,e&&(e.prev=r),this.head=r,this.tail||(this.tail=r),this.length++}};p.prototype.pushNode=function(r){if(r!==this.tail){r.list&&r.list.removeNode(r);var e=this.tail;r.list=this,r.prev=e,e&&(e.next=r),this.tail=r,this.head||(this.head=r),this.length++}};p.prototype.push=function(){for(var r=0,e=arguments.length;r<e;r++)li(this,arguments[r]);return this.length};p.prototype.unshift=function(){for(var r=0,e=arguments.length;r<e;r++)ci(this,arguments[r]);return this.length};p.prototype.pop=function(){if(!!this.tail){var r=this.tail.value;return this.tail=this.tail.prev,this.tail?this.tail.next=null:this.head=null,this.length--,r}};p.prototype.shift=function(){if(!!this.head){var r=this.head.value;return this.head=this.head.next,this.head?this.head.prev=null:this.tail=null,this.length--,r}};p.prototype.forEach=function(r,e){e=e||this;for(var t=this.head,i=0;t!==null;i++)r.call(e,t.value,i,this),t=t.next};p.prototype.forEachReverse=function(r,e){e=e||this;for(var t=this.tail,i=this.length-1;t!==null;i--)r.call(e,t.value,i,this),t=t.prev};p.prototype.get=function(r){for(var e=0,t=this.head;t!==null&&e<r;e++)t=t.next;if(e===r&&t!==null)return t.value};p.prototype.getReverse=function(r){for(var e=0,t=this.tail;t!==null&&e<r;e++)t=t.prev;if(e===r&&t!==null)return t.value};p.prototype.map=function(r,e){e=e||this;for(var t=new p,i=this.head;i!==null;)t.push(r.call(e,i.value,this)),i=i.next;return t};p.prototype.mapReverse=function(r,e){e=e||this;for(var t=new p,i=this.tail;i!==null;)t.push(r.call(e,i.value,this)),i=i.prev;return t};p.prototype.reduce=function(r,e){var t,i=this.head;if(arguments.length>1)t=e;else if(this.head)i=this.head.next,t=this.head.value;else throw new TypeError("Reduce of empty list with no initial value");for(var n=0;i!==null;n++)t=r(t,i.value,n),i=i.next;return t};p.prototype.reduceReverse=function(r,e){var t,i=this.tail;if(arguments.length>1)t=e;else if(this.tail)i=this.tail.prev,t=this.tail.value;else throw new TypeError("Reduce of empty list with no initial value");for(var n=this.length-1;i!==null;n--)t=r(t,i.value,n),i=i.prev;return t};p.prototype.toArray=function(){for(var r=new Array(this.length),e=0,t=this.head;t!==null;e++)r[e]=t.value,t=t.next;return r};p.prototype.toArrayReverse=function(){for(var r=new Array(this.length),e=0,t=this.tail;t!==null;e++)r[e]=t.value,t=t.prev;return r};p.prototype.slice=function(r,e){e=e||this.length,e<0&&(e+=this.length),r=r||0,r<0&&(r+=this.length);var t=new p;if(e<r||e<0)return t;r<0&&(r=0),e>this.length&&(e=this.length);for(var i=0,n=this.head;n!==null&&i<r;i++)n=n.next;for(;n!==null&&i<e;i++,n=n.next)t.push(n.value);return t};p.prototype.sliceReverse=function(r,e){e=e||this.length,e<0&&(e+=this.length),r=r||0,r<0&&(r+=this.length);var t=new p;if(e<r||e<0)return t;r<0&&(r=0),e>this.length&&(e=this.length);for(var i=this.length,n=this.tail;n!==null&&i>e;i--)n=n.prev;for(;n!==null&&i>r;i--,n=n.prev)t.push(n.value);return t};p.prototype.splice=function(r,e,...t){r>this.length&&(r=this.length-1),r<0&&(r=this.length+r);for(var i=0,n=this.head;n!==null&&i<r;i++)n=n.next;for(var s=[],i=0;n&&i<e;i++)s.push(n.value),n=this.removeNode(n);n===null&&(n=this.tail),n!==this.head&&n!==this.tail&&(n=n.prev);for(var i=0;i<t.length;i++)n=ui(this,n,t[i]);return s};p.prototype.reverse=function(){for(var r=this.head,e=this.tail,t=r;t!==null;t=t.prev){var i=t.prev;t.prev=t.next,t.next=i}return this.head=e,this.tail=r,this};function ui(r,e,t){var i=e===r.head?new oe(t,null,e,r):new oe(t,e,e.next,r);return i.next===null&&(r.tail=i),i.prev===null&&(r.head=i),r.length++,i}function li(r,e){r.tail=new oe(e,r.tail,null,r),r.head||(r.head=r.tail),r.length++}function ci(r,e){r.head=new oe(e,null,r.head,r),r.tail||(r.tail=r.head),r.length++}function oe(r,e,t,i){if(!(this instanceof oe))return new oe(r,e,t,i);this.list=i,this.value=r,e?(e.next=this,this.prev=e):this.prev=null,t?(t.prev=this,this.next=t):this.next=null}try{Mt()(p)}catch(r){}});var tt=N((nn,$t)=>{"use strict";var fi=Kt(),ue=Symbol("max"),Q=Symbol("length"),me=Symbol("lengthCalculator"),Te=Symbol("allowStale"),le=Symbol("maxAge"),J=Symbol("dispose"),kt=Symbol("noDisposeOnSet"),x=Symbol("lruList"),L=Symbol("cache"),jt=Symbol("updateAgeOnGet"),Ze=()=>1,zt=class{constructor(e){if(typeof e=="number"&&(e={max:e}),e||(e={}),e.max&&(typeof e.max!="number"||e.max<0))throw new TypeError("max must be a non-negative number");let t=this[ue]=e.max||1/0,i=e.length||Ze;if(this[me]=typeof i!="function"?Ze:i,this[Te]=e.stale||!1,e.maxAge&&typeof e.maxAge!="number")throw new TypeError("maxAge must be a number");this[le]=e.maxAge||0,this[J]=e.dispose,this[kt]=e.noDisposeOnSet||!1,this[jt]=e.updateAgeOnGet||!1,this.reset()}set max(e){if(typeof e!="number"||e<0)throw new TypeError("max must be a non-negative number");this[ue]=e||1/0,Ae(this)}get max(){return this[ue]}set allowStale(e){this[Te]=!!e}get allowStale(){return this[Te]}set maxAge(e){if(typeof e!="number")throw new TypeError("maxAge must be a non-negative number");this[le]=e,Ae(this)}get maxAge(){return this[le]}set lengthCalculator(e){typeof e!="function"&&(e=Ze),e!==this[me]&&(this[me]=e,this[Q]=0,this[x].forEach(t=>{t.length=this[me](t.value,t.key),this[Q]+=t.length})),Ae(this)}get lengthCalculator(){return this[me]}get length(){return this[Q]}get itemCount(){return this[x].length}rforEach(e,t){t=t||this;for(let i=this[x].tail;i!==null;){let n=i.prev;Yt(this,e,i,t),i=n}}forEach(e,t){t=t||this;for(let i=this[x].head;i!==null;){let n=i.next;Yt(this,e,i,t),i=n}}keys(){return this[x].toArray().map(e=>e.key)}values(){return this[x].toArray().map(e=>e.value)}reset(){this[J]&&this[x]&&this[x].length&&this[x].forEach(e=>this[J](e.key,e.value)),this[L]=new Map,this[x]=new fi,this[Q]=0}dump(){return this[x].map(e=>Ue(this,e)?!1:{k:e.key,v:e.value,e:e.now+(e.maxAge||0)}).toArray().filter(e=>e)}dumpLru(){return this[x]}set(e,t,i){if(i=i||this[le],i&&typeof i!="number")throw new TypeError("maxAge must be a number");let n=i?Date.now():0,s=this[me](t,e);if(this[L].has(e)){if(s>this[ue])return pe(this,this[L].get(e)),!1;let c=this[L].get(e).value;return this[J]&&(this[kt]||this[J](e,c.value)),c.now=n,c.maxAge=i,c.value=t,this[Q]+=s-c.length,c.length=s,this.get(e),Ae(this),!0}let a=new Ht(e,t,s,n,i);return a.length>this[ue]?(this[J]&&this[J](e,t),!1):(this[Q]+=a.length,this[x].unshift(a),this[L].set(e,this[x].head),Ae(this),!0)}has(e){if(!this[L].has(e))return!1;let t=this[L].get(e).value;return!Ue(this,t)}get(e){return et(this,e,!0)}peek(e){return et(this,e,!1)}pop(){let e=this[x].tail;return e?(pe(this,e),e.value):null}del(e){pe(this,this[L].get(e))}load(e){this.reset();let t=Date.now();for(let i=e.length-1;i>=0;i--){let n=e[i],s=n.e||0;if(s===0)this.set(n.k,n.v);else{let a=s-t;a>0&&this.set(n.k,n.v,a)}}}prune(){this[L].forEach((e,t)=>et(this,t,!1))}},et=(r,e,t)=>{let i=r[L].get(e);if(i){let n=i.value;if(Ue(r,n)){if(pe(r,i),!r[Te])return}else t&&(r[jt]&&(i.value.now=Date.now()),r[x].unshiftNode(i));return n.value}},Ue=(r,e)=>{if(!e||!e.maxAge&&!r[le])return!1;let t=Date.now()-e.now;return e.maxAge?t>e.maxAge:r[le]&&t>r[le]},Ae=r=>{if(r[Q]>r[ue])for(let e=r[x].tail;r[Q]>r[ue]&&e!==null;){let t=e.prev;pe(r,e),e=t}},pe=(r,e)=>{if(e){let t=e.value;r[J]&&r[J](t.key,t.value),r[Q]-=t.length,r[L].delete(t.key),r[x].removeNode(e)}},Ht=class{constructor(e,t,i,n,s){this.key=e,this.value=t,this.length=i,this.now=n,this.maxAge=s||0}},Yt=(r,e,t,i)=>{let n=t.value;Ue(r,n)&&(pe(r,t),r[Te]||(n=void 0)),n&&e.call(i,n.value,n.key,r)};$t.exports=zt});var vr=N((cn,it)=>{(function(){var r=this;let e=a=>new TextEncoder().encode(a);function t(a,u){typeof a=="string"&&(a=e(a));for(var c=a.length,o=u^c,l=0,m;c>=4;)m=a[l]&255|(a[++l]&255)<<8|(a[++l]&255)<<16|(a[++l]&255)<<24,m=(m&65535)*1540483477+(((m>>>16)*1540483477&65535)<<16),m^=m>>>24,m=(m&65535)*1540483477+(((m>>>16)*1540483477&65535)<<16),o=(o&65535)*1540483477+(((o>>>16)*1540483477&65535)<<16)^m,c-=4,++l;switch(c){case 3:o^=(a[l+2]&255)<<16;case 2:o^=(a[l+1]&255)<<8;case 1:o^=a[l]&255,o=(o&65535)*1540483477+(((o>>>16)*1540483477&65535)<<16)}return o^=o>>>13,o=(o&65535)*1540483477+(((o>>>16)*1540483477&65535)<<16),o^=o>>>15,o>>>0}function i(a,u){typeof a=="string"&&(a=e(a));var c,o,l,m,A,C,P,W,h,T;for(c=a.length&3,o=a.length-c,l=u,A=3432918353,P=461845907,T=0;T<o;)h=a[T]&255|(a[++T]&255)<<8|(a[++T]&255)<<16|(a[++T]&255)<<24,++T,h=(h&65535)*A+(((h>>>16)*A&65535)<<16)&4294967295,h=h<<15|h>>>17,h=(h&65535)*P+(((h>>>16)*P&65535)<<16)&4294967295,l^=h,l=l<<13|l>>>19,m=(l&65535)*5+(((l>>>16)*5&65535)<<16)&4294967295,l=(m&65535)+27492+(((m>>>16)+58964&65535)<<16);switch(h=0,c){case 3:h^=(a[T+2]&255)<<16;case 2:h^=(a[T+1]&255)<<8;case 1:h^=a[T]&255,h=(h&65535)*A+(((h>>>16)*A&65535)<<16)&4294967295,h=h<<15|h>>>17,h=(h&65535)*P+(((h>>>16)*P&65535)<<16)&4294967295,l^=h}return l^=a.length,l^=l>>>16,l=(l&65535)*2246822507+(((l>>>16)*2246822507&65535)<<16)&4294967295,l^=l>>>13,l=(l&65535)*3266489909+(((l>>>16)*3266489909&65535)<<16)&4294967295,l^=l>>>16,l>>>0}var n=i;if(n.v2=t,n.v3=i,typeof it!="undefined")it.exports=n;else{var s=r.murmur;n.noConflict=function(){return r.murmur=s,n},r.murmur=n}})()});Nr(exports,{Client:()=>xe,Event:()=>I,FileStore:()=>Re,LRU:()=>Rr.default,default:()=>vi});var Tr=D(require("events")),Ar=D(pt()),at=D(require("axios")),ot=D(xt());var S;(function(a){a.READY="stream_ready",a.CONNECTED="stream_connected",a.RETRYING="stream_retrying",a.DISCONNECTED="stream_disconnected",a.CHANGED="stream_changed",a.ERROR="stream_error"})(S||(S={}));var j=D(require("axios"));var Pt=D(require("axios")),U="http://localhost/api/1.0".replace(/\/+$/,"");var we=class{constructor(e,t=U,i=Pt.default){this.basePath=t;this.axios=i;e&&(this.configuration=e,this.basePath=e.basePath||this.basePath)}},Ye=class extends Error{constructor(e,t){super(t);this.field=e;this.name="RequiredError"}};var M="https://example.com",_=function(r,e,t){if(t==null)throw new Ye(e,`Required parameter ${e} was null or undefined when calling ${r}.`)};var $=async function(r,e){if(e&&e.accessToken){let t=typeof e.accessToken=="function"?await e.accessToken():await e.accessToken;r.Authorization="Bearer "+t}};var G=function(r,...e){let t=new URLSearchParams(r.search);for(let i of e)for(let n in i)if(Array.isArray(i[n])){t.delete(n);for(let s of i[n])t.append(n,s)}else t.set(n,i[n]);r.search=t.toString()},$e=function(r,e,t){let i=typeof r!="string";return(i&&t&&t.isJsonMime?t.isJsonMime(e.headers["Content-Type"]):i)?JSON.stringify(r!==void 0?r:{}):r||""},K=function(r){return r.pathname+r.search+r.hash},k=function(r,e,t,i){return(n=e,s=t)=>{let a=Oe(f({},r.options),{url:((i==null?void 0:i.basePath)||s)+r.url});return n.request(a)}};var ne;(function(n){n.Boolean="boolean",n.Int="int",n.String="string",n.Json="json"})(ne||(ne={}));var Ne;(function(t){t.On="on",t.Off="off"})(Ne||(Ne={}));var De;(function(e){e.Ffmetrics="FFMETRICS"})(De||(De={}));var Hr=function(r){return{authenticate:async(e,t={})=>{let i="/client/auth",n=new URL(i,M),s;r&&(s=r.baseOptions);let a=f(f({method:"POST"},s),t),u={},c={};u["Content-Type"]="application/json",G(n,c,t.query);let o=s&&s.headers?s.headers:{};return a.headers=f(f(f({},u),o),t.headers),a.data=$e(e,a,r),{url:K(n),options:a}},getAllSegments:async(e,t,i={})=>{_("getAllSegments","environmentUUID",e);let n="/client/env/{environmentUUID}/target-segments".replace("{environmentUUID}",encodeURIComponent(String(e))),s=new URL(n,M),a;r&&(a=r.baseOptions);let u=f(f({method:"GET"},a),i),c={},o={};await $(c,r),t!==void 0&&(o.cluster=t),G(s,o,i.query);let l=a&&a.headers?a.headers:{};return u.headers=f(f(f({},c),l),i.headers),{url:K(s),options:u}},getEvaluationByIdentifier:async(e,t,i,n,s={})=>{_("getEvaluationByIdentifier","environmentUUID",e),_("getEvaluationByIdentifier","feature",t),_("getEvaluationByIdentifier","target",i);let a="/client/env/{environmentUUID}/target/{target}/evaluations/{feature}".replace("{environmentUUID}",encodeURIComponent(String(e))).replace("{feature}",encodeURIComponent(String(t))).replace("{target}",encodeURIComponent(String(i))),u=new URL(a,M),c;r&&(c=r.baseOptions);let o=f(f({method:"GET"},c),s),l={},m={};await $(l,r),n!==void 0&&(m.cluster=n),G(u,m,s.query);let A=c&&c.headers?c.headers:{};return o.headers=f(f(f({},l),A),s.headers),{url:K(u),options:o}},getEvaluations:async(e,t,i,n={})=>{_("getEvaluations","environmentUUID",e),_("getEvaluations","target",t);let s="/client/env/{environmentUUID}/target/{target}/evaluations".replace("{environmentUUID}",encodeURIComponent(String(e))).replace("{target}",encodeURIComponent(String(t))),a=new URL(s,M),u;r&&(u=r.baseOptions);let c=f(f({method:"GET"},u),n),o={},l={};await $(o,r),i!==void 0&&(l.cluster=i),G(a,l,n.query);let m=u&&u.headers?u.headers:{};return c.headers=f(f(f({},o),m),n.headers),{url:K(a),options:c}},getFeatureConfig:async(e,t,i={})=>{_("getFeatureConfig","environmentUUID",e);let n="/client/env/{environmentUUID}/feature-configs".replace("{environmentUUID}",encodeURIComponent(String(e))),s=new URL(n,M),a;r&&(a=r.baseOptions);let u=f(f({method:"GET"},a),i),c={},o={};await $(c,r),t!==void 0&&(o.cluster=t),G(s,o,i.query);let l=a&&a.headers?a.headers:{};return u.headers=f(f(f({},c),l),i.headers),{url:K(s),options:u}},getFeatureConfigByIdentifier:async(e,t,i,n={})=>{_("getFeatureConfigByIdentifier","identifier",e),_("getFeatureConfigByIdentifier","environmentUUID",t);let s="/client/env/{environmentUUID}/feature-configs/{identifier}".replace("{identifier}",encodeURIComponent(String(e))).replace("{environmentUUID}",encodeURIComponent(String(t))),a=new URL(s,M),u;r&&(u=r.baseOptions);let c=f(f({method:"GET"},u),n),o={},l={};await $(o,r),i!==void 0&&(l.cluster=i),G(a,l,n.query);let m=u&&u.headers?u.headers:{};return c.headers=f(f(f({},o),m),n.headers),{url:K(a),options:c}},getSegmentByIdentifier:async(e,t,i,n={})=>{_("getSegmentByIdentifier","identifier",e),_("getSegmentByIdentifier","environmentUUID",t);let s="/client/env/{environmentUUID}/target-segments/{identifier}".replace("{identifier}",encodeURIComponent(String(e))).replace("{environmentUUID}",encodeURIComponent(String(t))),a=new URL(s,M),u;r&&(u=r.baseOptions);let c=f(f({method:"GET"},u),n),o={},l={};await $(o,r),i!==void 0&&(l.cluster=i),G(a,l,n.query);let m=u&&u.headers?u.headers:{};return c.headers=f(f(f({},o),m),n.headers),{url:K(a),options:c}},stream:async(e,t,i={})=>{_("stream","aPIKey",e);let n="/stream",s=new URL(n,M),a;r&&(a=r.baseOptions);let u=f(f({method:"GET"},a),i),c={},o={};await $(c,r),t!==void 0&&(o.cluster=t),e!=null&&(c["API-Key"]=String(e)),G(s,o,i.query);let l=a&&a.headers?a.headers:{};return u.headers=f(f(f({},c),l),i.headers),{url:K(s),options:u}}}},Z=function(r){let e=Hr(r);return{async authenticate(t,i){let n=await e.authenticate(t,i);return k(n,j.default,U,r)},async getAllSegments(t,i,n){let s=await e.getAllSegments(t,i,n);return k(s,j.default,U,r)},async getEvaluationByIdentifier(t,i,n,s,a){let u=await e.getEvaluationByIdentifier(t,i,n,s,a);return k(u,j.default,U,r)},async getEvaluations(t,i,n,s){let a=await e.getEvaluations(t,i,n,s);return k(a,j.default,U,r)},async getFeatureConfig(t,i,n){let s=await e.getFeatureConfig(t,i,n);return k(s,j.default,U,r)},async getFeatureConfigByIdentifier(t,i,n,s){let a=await e.getFeatureConfigByIdentifier(t,i,n,s);return k(a,j.default,U,r)},async getSegmentByIdentifier(t,i,n,s){let a=await e.getSegmentByIdentifier(t,i,n,s);return k(a,j.default,U,r)},async stream(t,i,n){let s=await e.stream(t,i,n);return k(s,j.default,U,r)}}};var Qe=class extends we{authenticate(e,t){return Z(this.configuration).authenticate(e,t).then(i=>i(this.axios,this.basePath))}getAllSegments(e,t,i){return Z(this.configuration).getAllSegments(e,t,i).then(n=>n(this.axios,this.basePath))}getEvaluationByIdentifier(e,t,i,n,s){return Z(this.configuration).getEvaluationByIdentifier(e,t,i,n,s).then(a=>a(this.axios,this.basePath))}getEvaluations(e,t,i,n){return Z(this.configuration).getEvaluations(e,t,i,n).then(s=>s(this.axios,this.basePath))}getFeatureConfig(e,t,i){return Z(this.configuration).getFeatureConfig(e,t,i).then(n=>n(this.axios,this.basePath))}getFeatureConfigByIdentifier(e,t,i,n){return Z(this.configuration).getFeatureConfigByIdentifier(e,t,i,n).then(s=>s(this.axios,this.basePath))}getSegmentByIdentifier(e,t,i,n){return Z(this.configuration).getSegmentByIdentifier(e,t,i,n).then(s=>s(this.axios,this.basePath))}stream(e,t,i){return Z(this.configuration).stream(e,t,i).then(n=>n(this.axios,this.basePath))}},Yr=function(r){return{postMetrics:async(e,t,i,n={})=>{_("postMetrics","environment",e);let s="/metrics/{environment}".replace("{environment}",encodeURIComponent(String(e))),a=new URL(s,M),u;r&&(u=r.baseOptions);let c=f(f({method:"POST"},u),n),o={},l={};await $(o,r),t!==void 0&&(l.cluster=t),o["Content-Type"]="application/json",G(a,l,n.query);let m=u&&u.headers?u.headers:{};return c.headers=f(f(f({},o),m),n.headers),c.data=$e(i,c,r),{url:K(a),options:c}}}},$r=function(r){let e=Yr(r);return{async postMetrics(t,i,n,s){let a=await e.postMetrics(t,i,n,s);return k(a,j.default,U,r)}}};var Je=class extends we{postMetrics(e,t,i,n){return $r(this.configuration).postMetrics(e,t,i,n).then(s=>s(this.axios,this.basePath))}};var Ee=class{constructor(e={}){this.apiKey=e.apiKey,this.username=e.username,this.password=e.password,this.accessToken=e.accessToken,this.basePath=e.basePath,this.baseOptions=e.baseOptions,this.formDataCtor=e.formDataCtor}isJsonMime(e){let t=new RegExp("^(application/json|[^;/ 	]+/[^;/ 	]+[+]json)[ 	]*(;.*)?$","i");return e!==null&&(t.test(e)||e.toLowerCase()==="application/json-patch+json")}};var Fe="1.2.15";var se;(function(t){t.READY="poller_ready",t.ERROR="poller_error"})(se||(se={}));var We=class{constructor(e,t,i,n,s,a){this.stopped=!0;this.initialized=!1;this.api=i,this.options=n,this.environment=e,this.cluster=t,this.repository=a,this.eventBus=s,this.log=n.logger}poll(){if(this.stopped){this.log.info("PollingProcessor stopped");return}let e=new Date().getTime(),t=()=>{let i=new Date().getTime()-e,n=Math.max(this.options.pollInterval-i,0);this.timeout=setTimeout(()=>this.poll(),n)};Promise.all([this.retrieveFlags(),this.retrieveSegments()]).then(()=>{this.initialized||(this.initialized=!0,this.eventBus.emit(se.READY))}).catch(i=>{this.eventBus.emit(se.ERROR,{error:i})}).finally(()=>{if(this.stopped){this.log.info("PollingProcessor stopped");return}t()})}async retrieveFlags(){try{this.log.debug("Fetching flags started");let e=await this.api.getFeatureConfig(this.environment,this.cluster);this.log.debug("Fetching flags finished"),e.data.forEach(t=>this.repository.setFlag(t.feature,t))}catch(e){throw this.log.error("Error loading flags",e),e}}async retrieveSegments(){try{this.log.debug("Fetching segments started");let e=await this.api.getAllSegments(this.environment,this.cluster);this.log.debug("Fetching segments finished"),e.data.forEach(t=>this.repository.setSegment(t.identifier,t))}catch(e){throw this.log.error("Error loading segments",e),e}}start(){if(!this.stopped){this.log.info("PollingProcessor already started");return}this.log.info("Starting PollingProcessor with request interval: ",this.options.pollInterval),this.stopped=!1,this.poll()}stop(){this.log.info("Stopping PollingProcessor"),this.stopped=!0}close(){this.log.info("Closing PollingProcessor"),this.stop(),clearTimeout(this.timeout),this.log.info("PollingProcessor closed")}};var Bt=D(Lt());var Xe=class{constructor(e,t,i,n,s,a,u,c){this.api=e,this.apiKey=t,this.environment=i,this.jwtToken=n,this.options=s,this.cluster=a,this.eventBus=u,this.repository=c,this.log=this.options.logger}start(){this.log.info("Starting StreamProcessor");let e=new Bt.default(`${this.options.baseUrl}/stream?cluster=${this.cluster}`,{headers:{Authorization:`Bearer ${this.jwtToken}`,"API-Key":this.apiKey}});e.onopen=t=>{this.log.debug("Stream connected",t),this.eventBus.emit(S.CONNECTED),this.isRetrying=!1},e.onretrying=t=>{this.log.error("Stream is trying to reconnect",t),this.isRetrying||(this.isRetrying=!0,this.eventBus.emit(S.RETRYING))},e.onerror=t=>{this.log.error("Unrecoverable error with stream, not retrying to connect: ",t),this.eventBus.emit(S.ERROR,t)},e.addEventListener("*",t=>{let i=JSON.parse(t.data);this.log.debug("Received event from stream: ",i),i.domain==="flag"?this.msgProcessor(i,this.api.getFeatureConfigByIdentifier.bind(this.api),this.repository.setFlag.bind(this.repository),this.repository.deleteFlag.bind(this.repository)):i.domain==="target-segment"&&this.msgProcessor(i,this.api.getSegmentByIdentifier.bind(this.api),this.repository.setSegment.bind(this.repository),this.repository.deleteSegment.bind(this.repository))}),this.eventSource=e,this.eventBus.emit(S.READY)}async msgProcessor(e,t,i,n){this.log.info("Processing message",e);try{if(e.event==="create"||e.event==="patch"){let{data:s}=await t(e.identifier,this.environment,this.cluster);i(e.identifier,s)}else e.event==="delete"&&n(e.identifier)}catch(s){throw this.log.error("Error while fetching data with identifier:",e.identifier,s),s}this.log.info("Processing message finished",e)}connected(){return this.eventSource.readyState==Xe.CONNECTED}stop(){this.log.info("Stopping StreamProcessor"),this.eventSource.close(),this.eventBus.emit(S.DISCONNECTED)}close(){this.log.info("Closing StreamProcessor"),this.stop(),this.log.info("StreamProcessor closed")}},Ve=Xe;Ve.CONNECTED=1;var Wt=D(tt());var rt=class{trace(e,...t){console.trace(e,...t)}debug(e,...t){console.debug(e,...t)}info(e,...t){console.info(e,...t)}warn(e,...t){console.warn(e,...t)}error(e,...t){console.error(e,...t)}};var Qt=D(require("keyv")),Jt=D(require("keyv-file")),Re=class{constructor(e={}){this.keyvFile=new Jt.KeyvFile(e),this.keyv=new Qt.default({store:this.keyvFile})}set(e,t){return this.keyv.set(e,t)}get(e){return this.keyv.get(e)}del(e){return this.keyv.delete(e)}keys(){return Promise.resolve(this.keyvFile.keys())}};var Xt=100;var Zt="featureIdentifier",er="featureName",tr="variationIdentifier";var rr="target",ir="SDK_VERSION",nr="SDK_TYPE",sr="server",ar="SDK_LANGUAGE",or="javascript",ur="global",be="segmentMatch",lr="in",cr="equal",fr="gt",hr="starts_with",gr="ends_with",mr="contains",pr="equal_sensitive",hi="https://config.ff.harness.io/api/1.0",gi="https://events.ff.harness.io/api/1.0",mi=1e3,dr=60*mi,pi=1*dr,di=1*dr,te={baseUrl:hi,eventsUrl:gi,pollInterval:pi,eventsSyncInterval:di,enableStream:!0,enableAnalytics:!0,cache:new Wt.default({max:100}),store:new Re,logger:new rt};var yr=D(vr()),nt=class{constructor(e,t){this.query=e,this.log=t}getAttrValue(e,t){var i;return e[t]||((i=e.attributes)==null?void 0:i[t])}findVariation(e,t){return e.find(i=>i.identifier===t)}getNormalizedNumberWithNormalizer(e,t,i){let n=[t,e].join(":");return parseInt((0,yr.default)(n).toString())%i+1}getNormalizedNumber(e,t){return this.getNormalizedNumberWithNormalizer(e,t,Xt)}isEnabled(e,t,i){let n=this.getAttrValue(e,t);if(!n)return!1;let s=this.getNormalizedNumber(n,t);return i>0&&s<=i}evaluateDistribution(e,t){if(!e)return;let i="",n=0;for(let s of e.variations)if(i=s.variation,n+=s.weight,this.isEnabled(t,e.bucketBy,n))return s.variation;return i}async isTargetIncludedOrExcludedInSegment(e,t){var i,n;for(let s of e){let a=await this.query.getSegment(s);if(a){if((i=a.excluded)==null?void 0:i.find(u=>u.identifier===t.identifier))return this.log.debug(`Target %s excluded from segment %s via exclude list
`,t.name,a.name),!1;if((n=a.included)==null?void 0:n.find(u=>u.identifier===t.identifier))return this.log.debug(`Target %s included in segment %s via include list
`,t.name,a.name),!0;if(a.rules&&await this.evaluateClauses(a.rules,t))return this.log.debug(`Target %s included in segment %s via rules
`,t.name,a.name),!0}}return!1}async evaluateClause(e,t){var a;if(!(e==null?void 0:e.op)||!((a=e==null?void 0:e.values)==null?void 0:a.length))return!1;let i=this.getAttrValue(t,e.attribute),n=i==null?void 0:i.toString();if(e.op!==be&&!n)return!1;let s=e.values[0];switch(e.op){case lr:for(let u of e.values)if(u==n)return!0;return!1;case cr:return n.toLowerCase()==s.toLowerCase();case pr:return n==s;case fr:return n>s;case hr:return n.startsWith(s);case gr:return n.endsWith(s);case mr:return n.includes(s);case be:return await this.isTargetIncludedOrExcludedInSegment(e.values,t)}return!1}async evaluateClauses(e,t){for(let i of e)if(await this.evaluateClause(i,t))return!0;return!1}evaluateRule(e,t){return this.evaluateClauses(e.clauses,t)}async evaluateRules(e,t){if(!t||!e)return;e.sort((n,s)=>n.priority>s.priority?1:-1);let i;for(let n of e)if(!!await this.evaluateRule(n,t))return n.serve.distribution&&(i=this.evaluateDistribution(n.serve.distribution,t)),n.serve.variation&&(i=n.serve.variation),i}async evaluateVariationMap(e,t){var i;if(!(!t||!e))for(let n of e){if((i=n.targets)==null?void 0:i.find(u=>u.identifier===t.identifier))return n.variation;let a=n.targetSegments;if(a&&await this.isTargetIncludedOrExcludedInSegment(a,t))return n.variation}}async evaluateFlag(e,t){let i=e.offVariation;return e.state===Ne.On&&(i=await this.evaluateVariationMap(e.variationToTargetMap,t)||await this.evaluateRules(e.rules,t)||this.evaluateDistribution(e.defaultServe.distribution,t)||e.defaultServe.variation),this.findVariation(e.variations,i)}async checkPreRequisite(e,t){if(e.prerequisites){this.log.info("Checking pre requisites %s of parent feature %s",e.prerequisites,e.feature);for(let i of e.prerequisites){let n=await this.query.getFlag(i.feature);if(!n)return this.log.warn("Could not retrieve the pre requisite details of feature flag: %s",e.feature),!0;let s=await this.evaluateFlag(n,t);return this.log.info("Pre requisite flag %s has variation %s for target %s",n.feature,s,t),this.log.info("Pre requisite flag %s should have the variations %s",n.feature,i.variations),i.variations.includes(s.identifier)?await this.checkPreRequisite(n,t):!1}}return!0}async evaluate(e,t,i,n){let s=await this.query.getFlag(e);if(!s||s.kind!==i)return;if(s.prerequisites&&!await this.checkPreRequisite(s,t))return this.findVariation(s.variations,s.offVariation);let a=await this.evaluateFlag(s,t);if(a)return n&&n(s,t,a),a}async boolVariation(e,t,i=!1,n){let s=await this.evaluate(e,t,ne.Boolean,n);return s?s.value.toLowerCase()==="true":i}async stringVariation(e,t,i="",n){let s=await this.evaluate(e,t,ne.String,n);return s?s.value:i}async numberVariation(e,t,i=0,n){let s=await this.evaluate(e,t,ne.Int,n);return s?parseFloat(s.value):i}async jsonVariation(e,t,i={},n){let s=await this.evaluate(e,t,ne.Json,n);return s?JSON.parse(s.value):i}};var V;(function(n){n.FLAG_STORED="flag_stored",n.FLAG_DELETED="flag_deleted",n.SEGMENT_STORED="segment_stored",n.SEGMENT_DELETED="segment_deleted"})(V||(V={}));var st=class{constructor(e,t,i){if(!e)throw new Error("Cache is required argument and cannot be undefined");this.eventBus=i,this.cache=e,this.store=t}async setFlag(e,t){if(await this.isFlagOutdated(e,t))return;let i=this.formatFlagKey(e);this.store?(await this.store.set(i,t),this.cache.del(i)):this.cache.set(i,t),this.eventBus&&this.eventBus.emit(V.FLAG_STORED,e)}async setSegment(e,t){if(await this.isSegmentOutdated(e,t))return;let i=this.formatSegmentKey(e);this.store?(await this.store.set(i,t),this.cache.del(i)):this.cache.set(i,t),this.eventBus&&this.eventBus.emit(V.SEGMENT_STORED,e)}async deleteFlag(e){let t=this.formatFlagKey(e);this.store&&await this.store.del(t),this.cache.del(t),this.eventBus&&this.eventBus.emit(V.FLAG_DELETED,e)}async deleteSegment(e){let t=this.formatSegmentKey(e);this.store&&await this.store.del(t),this.cache.del(t),this.eventBus&&this.eventBus.emit(V.SEGMENT_DELETED,e)}async getFlag(e,t=!0){let i=this.formatFlagKey(e),n=this.cache.get(i);if(n)return n;if(this.store)return n=await this.store.get(i),n&&t&&this.cache.set(i,n),n}async getSegment(e,t=!0){let i=this.formatSegmentKey(e),n=this.cache.get(i);if(n)return n;if(this.store)return n=await this.store.get(i),n&&t&&this.cache.set(i,n),n}async findFlagsBySegment(e){let t=[],i=this.cache.keys();this.store&&(i=await this.store.keys());for(let n of i){let s=await this.getFlag(n);if(!s)return[];for(let a of s==null?void 0:s.rules)for(let u of a==null?void 0:a.clauses)u.op===be&&u.values.includes(e)&&t.push(s.feature)}return t}async isFlagOutdated(e,t){let i=await this.getFlag(e,!1);return(i==null?void 0:i.version)&&i.version>=(t==null?void 0:t.version)}async isSegmentOutdated(e,t){let i=await this.getSegment(e,!1);return(i==null?void 0:i.version)&&i.version>=(t==null?void 0:t.version)}formatFlagKey(e){return`flags/${e}`}formatSegmentKey(e){return`segments/${e}`}};var de;(function(t){t.READY="metrics_ready",t.ERROR="metrics_error"})(de||(de={}));var Er=(r,e="1",t,i,n)=>{let s=new Map,a,u=new Ee(Oe(f({},t),{basePath:i.eventsUrl})),c=new Je(u),o=i.logger,l=(h,T,g)=>{let v={target:h,featureConfig:T,variation:g,count:0},b=m(v),y=s.get(b);y?y.count++:(v.count=1,s.set(b,v))},m=h=>{let T=h.featureConfig.feature,g=h.variation.identifier,v=h.variation.value;return`${T}/${g}/${v}/${ur}`},A=()=>{var v,b;if(!s){o.debug("No metrics data!");return}let h=[],T=[],g=new Map(s);s.clear();for(let y of g.values()){if(y.target&&!y.target.anonymous){let O=[];y.target.attributes&&(O=Object.entries(y.target.attributes).map(([X,E])=>({key:X,value:E})));let q=y.target.identifier;y.target.name&&(q=y.target.name);let ce={identifier:y.target.identifier,name:q,attributes:O};h.push(ce)}let z=[{key:Zt,value:y.featureConfig.feature},{key:er,value:y.featureConfig.feature},{key:tr,value:y.variation.identifier},{key:nr,value:sr},{key:ar,value:or},{key:ir,value:Fe},{key:rr,value:(b=(v=y==null?void 0:y.target)==null?void 0:v.identifier)!=null?b:null}],B={timestamp:Date.now(),count:y.count,metricsType:De.Ffmetrics,attributes:z};T.push(B)}return{targetData:h,metricsData:T}},C=()=>{let h=A();h&&(o.debug("Start sending metrics data"),c.postMetrics(r,e,h).then(T=>{o.debug("Metrics server returns: ",T.status),T.status>=400&&o.error("Error while sending metrics data with status code: ",T.status)}).catch(T=>{o.debug("Metrics server returns error: ",T)}))};return{start:()=>{o.info("Starting MetricsProcessor with request interval: ",i.eventsSyncInterval),a=setInterval(C,i.eventsSyncInterval),n.emit(de.READY)},close:()=>{o.info("Closing MetricsProcessor"),clearInterval(a),C(),o.info("MetricsProcessor closed")},enqueue:l}};at.default.defaults.timeout=3e4;(0,ot.default)(at.default,{retries:3,retryDelay:ot.default.exponentialDelay});var re;(function(i){i[i.POLL=0]="POLL",i[i.STREAM=1]="STREAM",i[i.METRICS=2]="METRICS"})(re||(re={}));var I;(function(i){i.READY="ready",i.FAILED="failed",i.CHANGED="changed"})(I||(I={}));var xe=class{constructor(e,t={}){this.cluster="1";this.eventBus=new Tr.default;this.initialized=!1;this.failure=!1;this.pollerReady=!1;this.streamReady=!1;this.metricReady=!1;this.closing=!1;this.sdkKey=e,this.options=f(f({},te),t),this.log=this.options.logger,t.pollInterval<te.pollInterval&&(this.options.pollInterval=te.pollInterval,this.log.warn(`Polling interval cannot be lower than ${te.pollInterval} ms`)),t.eventsSyncInterval<te.eventsSyncInterval&&(this.options.eventsSyncInterval=te.eventsSyncInterval,this.log.warn(`Events sync interval cannot be lower than ${te.eventsSyncInterval} ms`)),this.configuration=new Ee({basePath:this.options.baseUrl,baseOptions:{headers:{"User-Agent":`NodeJsSDK/${Fe}`}}}),this.repository=new st(this.options.cache,this.options.store,this.eventBus),this.evaluator=new nt(this.repository,this.log),this.api=new Qe(this.configuration),this.processEvents(),this.run()}processEvents(){this.eventBus.on(se.READY,()=>{this.initialize(0)}),this.eventBus.on(se.ERROR,()=>{this.failure=!0,this.eventBus.emit(I.FAILED)}),this.eventBus.on(S.READY,()=>{this.initialize(1)}),this.eventBus.on(S.RETRYING,()=>{this.failure=!0,this.log.error("Issue with streaming: falling back to polling while the SDK attempts to reconnect"),this.closing||this.pollProcessor.start()}),this.eventBus.on(S.ERROR,()=>{this.failure=!0,this.log.error("Unrecoverable issue with streaming: falling back to polling"),this.closing||this.pollProcessor.start(),this.eventBus.emit(I.FAILED)}),this.eventBus.on(de.READY,()=>{this.initialize(2)}),this.eventBus.on(de.ERROR,()=>{this.failure=!0,this.eventBus.emit(I.FAILED)}),this.eventBus.on(S.CONNECTED,()=>{this.pollProcessor.stop()}),this.eventBus.on(S.DISCONNECTED,()=>{this.closing||this.pollProcessor.start()});for(let e of Object.values(V))this.eventBus.on(e,t=>{switch(e){case V.FLAG_STORED:case V.FLAG_DELETED:this.eventBus.emit(I.CHANGED,t);break;case V.SEGMENT_STORED:case V.SEGMENT_DELETED:this.repository.findFlagsBySegment(t).then(i=>{i.forEach(n=>this.eventBus.emit(I.CHANGED,n))});break}})}on(e,t){let i=[];for(let n of Object.values(I))i.push(n);i.includes(e)&&this.eventBus.on(e,t)}off(e,t){e?this.eventBus.off(e,t):this.close()}async authenticate(){try{let e=await this.api.authenticate({apiKey:this.sdkKey});this.authToken=e.data.authToken,this.configuration.accessToken=this.authToken;let t=(0,Ar.default)(this.authToken);this.environment=t.environment,this.cluster=t.clusterIdentifier||"1"}catch(e){this.failure=!0,console.error("Error while authenticating, err: ",e)}}waitForInitialization(){return this.waitForInitialize?this.waitForInitialize:(this.initialized?this.waitForInitialize=Promise.resolve(this):this.failure?this.waitForInitialize=Promise.reject(this.failure):this.waitForInitialize=new Promise((e,t)=>{this.eventBus.once(I.READY,()=>{setTimeout(()=>e(this),0)}),this.eventBus.once(I.FAILED,t)}),this.waitForInitialize)}initialize(e){switch(e){case 0:this.pollerReady=!0,this.log.debug("PollingProcessor ready");break;case 1:this.streamReady=!0,this.log.debug("StreamingProcessor ready");break;case 2:this.metricReady=!0,this.log.debug("MetricsProcessor ready");break}this.options.enableStream&&!this.streamReady||this.options.enableAnalytics&&!this.metricReady||!this.pollerReady||(this.initialized=!0,this.eventBus.emit(I.READY))}async run(){await this.authenticate(),this.pollProcessor=new We(this.environment,this.cluster,this.api,this.options,this.eventBus,this.repository),this.pollProcessor.start(),this.options.enableStream&&(this.streamProcessor=new Ve(this.api,this.sdkKey,this.environment,this.authToken,this.options,this.cluster,this.eventBus,this.repository),this.streamProcessor.start()),this.options.enableAnalytics&&(this.metricsProcessor=Er(this.environment,this.cluster,this.configuration,this.options,this.eventBus),this.metricsProcessor.start()),this.log.info("finished setting up processors")}boolVariation(e,t,i=!1){return this.evaluator.boolVariation(e,t,i,(n,s,a)=>{this.metricsProcessor&&this.metricsProcessor.enqueue(s,n,a)})}stringVariation(e,t,i=""){return this.evaluator.stringVariation(e,t,i,(n,s,a)=>{this.metricsProcessor&&this.metricsProcessor.enqueue(s,n,a)})}numberVariation(e,t,i=0){return this.evaluator.numberVariation(e,t,i,(n,s,a)=>{this.metricsProcessor&&this.metricsProcessor.enqueue(s,n,a)})}jsonVariation(e,t,i={}){return this.evaluator.jsonVariation(e,t,i,(n,s,a)=>{this.metricsProcessor&&this.metricsProcessor.enqueue(s,n,a)})}close(){this.closing=!0,this.pollProcessor.close(),this.streamProcessor&&this.streamProcessor.close(),this.metricsProcessor&&this.metricsProcessor.close(),this.eventBus.removeAllListeners(),this.closing=!1}};var Rr=D(tt());var vi={instance:void 0,init:function(r,e){this.instance||(this.instance=new xe(r,e))},waitForInitialization:function(){return this.instance.waitForInitialization()},boolVariation:function(r,e,t=!1){return this.instance.boolVariation(r,e,t)},stringVariation:function(r,e,t=""){return this.instance.stringVariation(r,e,t)},numberVariation:function(r,e,t=0){return this.instance.numberVariation(r,e,t)},jsonVariation:function(r,e,t=""){return this.instance.jsonVariation(r,e,t)},on:function(r,e){this.instance.on(r,e)},off:function(r,e){this.instance.off(r,e)},close:function(){return this.instance.close()}};0&&(module.exports={Client,Event,FileStore,LRU});
//# sourceMappingURL=index.js.map
